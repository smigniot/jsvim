<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" type="text/css" href="static/xterm.css" />
    <link rel="stylesheet" type="text/css" href="static/jsvim.css" />
    <script type="text/javascript" src="static/xterm.js"></script>
    <script type="text/javascript" src="static/jsvmain.js"></script>
<script type="text/javascript">
    function vim_tgetnum(name) {
      var res = sub_vim_tgetnum(name) || 0;
      console.log("TGET", name, res);
      return res;
    }
    function sub_vim_tgetnum(name) {
      if(name == "co") return 80;
      if(name == "li") return 24;
    }
    function vim_getColumns() { return 80; }
    function vim_getRows() { return 24; }
    function vim_charIn(c) {
      console.log("OUT",c, String.fromCharCode(c));
      if(c) { // NO padding on this DOM terminal
        //if(c != 7) { // xtermjs is reacting w.3.1.r.d !
          document.querySelector("#terminal-container").term.write(String.fromCharCode(c));
        //}
      }
    }

    var __IO_KEYS = [];
    function vim_putchar(c) {
      return Module.charIn(c);
    }
    function vim_tgetflag(name) {
      console.log("vim_tgetflag(",name,")");
      //auto_right_margin         am    am    terminal has automatic
      //margins
      if(name == "am") return 1; // Terminal auto-wrap at end of line
      //eat_newline_glitch        xenl  xn    newline ignored
      //after 80 cols (concept)
      if(name == "xn") return 0; // Never ignore newlines, even after 80col
      //move_standout_mode        msgr  ms    safe to move while
      //in standout mode
      if(name == "ms") return 1; // Safe to move
      return 0;
    }
    function vim_kbgetc() {
        var key_struct_list = __IO_KEYS.splice(0,1);
        if(key_struct_list.length) {
            var key_struct = key_struct_list[0];
            var c_or_kc = key_struct.c;
            if(c_or_kc == 0) {
                c_or_kc = key_struct.kc;
            }
            console.log("IN["+(+c_or_kc)+"]", key_struct);
            return +c_or_kc;
        }
        return +0;
    }

    var Module = {
        charIn: function(c){},
        io_keys: [],
        preRun: [(function() {
            function charIn(c) {
                //document.querySelector("#terminal-container").term.write(String.fromCharCode(c));
                vim_charIn(c);
            }
            Module.charIn = charIn;
            var _t = document.querySelector("#terminal-container").term;
            _t.on('key',(key,event)=>{
                console.log("XTERM input", key, event);
                event && event.preventDefault && event.preventDefault();
                __IO_KEYS.push({
                    "k" : key || event.key,
                    "c" : event.charCode,
                    "kc" : event.keyCode,
                });
                console.log("BUFFER", __IO_KEYS.length, __IO_KEYS);
            });
            FS.init(function() {
                console.log("NON-xvi stdin ?!?");
                return null;
            },charIn,function(c) {
                console.log("NON-xvi stdout/stderr", c);
            });
            FS.writeFile("jsxvi.help", [
                "~",
                " ",
                "           JSXvi - Xvi JavaScript",
                " ",
                "               version 1.0.0",
                "     by Sebastien Migniot, thx Martin Guy",
                " JSxvi is open source and freely distributable",
                " ",
                "            Become an xvi user !",
                " open  https://github.com/smigniot    for JSXvi",
                " open  https://github.com/martinwguy  for Xvi",
                " ",
                " type  :help<Enter>                   for help",
                " type  :q<Enter>                      to exit",
              ].join("\n~ "));
        })],
        postRun: [(function(){
            function timed_main_loop() {
                Module._jsvim_main_loop();
                setTimeout(timed_main_loop, 10);
            }
            console.log("START main loop");   
            timed_main_loop();
        })],
        print: (function(s) {console.log(s);}),
        printErr: (function(s) {console.log(s);}),
        canvas: (function() {}),
        setStatus: function(text) {},
        totalDependencies: 0,
        monitorRunDependencies: function(left) {},
    };
    function send_term(e) {
      var txt = e.textContent;
      var keys = txt.match(/(.|[\r\n])/gm).map(s=>s.charCodeAt(0)).map(c=>{return{c:c,hint:txt,ch:String.fromCharCode(c)}});
      console.log("TERMK", keys);
      var t = document.querySelector("#terminal-container").term;
      keys.forEach(k=>t.write(String.fromCharCode(k.c)));
    }
    function keyboard_type(e) {
      var txt = e.textContent;
      var keys = txt.match(/(.|[\r\n])/gm).map(s=>s.charCodeAt(0)).map(c=>{return{c:c,hint:txt,ch:String.fromCharCode(c)}});
      keys.forEach(k=>__IO_KEYS.push(k));
    }
</script>
  </head>
            <body>

    <p>JSXvi development version - try <code>:e jsxvi.help</code></p>
    <section class="tests">
      <h3>Send to term</h3>
      <!--
      <code onclick='send_term(this)'>line 1 with CRLF&#10;&#13;line 2&#10;&#13;line 3&#10;&#13;</code>
      <code onclick='send_term(this)'>line 1 with CR only&#10;line2&#10;line 3&#10;</code>
      -->
      <code onclick='send_term(this)'>back to (0,0)&#x1B;[1;1H</code>
      <code onclick='send_term(this)'>Hello</code>
      <code onclick='send_term(this)'>&#35;&#27;&#91;&#50;&#52;&#59;&#57;&#102;&#27;&#91;&#55;&#109;&#91;&#77;&#111;&#100;&#105;&#102;&#105;&#101;&#100;&#93;</code>

      <h3>Send to xvi</h3>
      <code onclick='keyboard_type(this)'>oSome test failed&#27;:.s/test.failed/success so far/&#10;</code>
      <code onclick='keyboard_type(this)'>i#
# Hello world
#&#27;</code>
      <code onclick='keyboard_type(this)'>oSome things&#27;bcWserious matter&#10;&#27;</code>
      <code onclick='keyboard_type(this)'>oSome other things&#27;bcwserious matter&#10;&#27;</code>
    </section>
    <div id="terminal-container"></div> 

    <script type="text/javascript">
    (function() {
        var memoryInitializer = '../src/xvi.html.mem';
        if (typeof Module['locateFile'] === 'function') {
            memoryInitializer = Module['locateFile'](memoryInitializer);
        } else if (Module['memoryInitializerPrefixURL']) {
            memoryInitializer = Module['memoryInitializerPrefixURL'] + memoryInitializer;
        }
        var xhr = Module['memoryInitializerRequest'] = new XMLHttpRequest();
        xhr.open('GET', memoryInitializer, true);
        xhr.responseType = 'arraybuffer';
        xhr.send(null);
    })();

    jsvimOnLoad();

    var script = document.createElement('script');
    script.src = "../src/xvi.js";
    document.body.appendChild(script);
    </script>
  </body>
</html>
<!-- vim: set ts=2 sw=2 sts=2 expandtab foldmethod=marker : --> 


