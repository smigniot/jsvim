<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" type="text/css" href="static/xterm.css" />
    <link rel="stylesheet" type="text/css" href="static/jsvim.css" />
    <script type="text/javascript" src="static/xterm.js"></script>
    <script type="text/javascript" src="static/jsvmain.js"></script>
<script type="text/javascript">
    function vim_getColumns() { return 80; }
    function vim_getRows() { return 24; }
    function vim_charIn(c) {
      console.log("OUT",c);
      document.querySelector("#terminal-container").term.write(String.fromCharCode(c));
    }

    var __IO_KEYS = [];
    function vim_kbgetc() {
        var key_struct_list = __IO_KEYS.splice(0,1);
        if(key_struct_list.length) {
            var key_struct = key_struct_list[0];
            var c_or_kc = key_struct.c;
            if(c_or_kc == 0) {
                c_or_kc = key_struct.kc;
            }
            console.log("IN["+(+c_or_kc)+"]", key_struct);
            return +c_or_kc;
        }
        return +0;
    }

    var Module = {
        charIn: function(c){},
        io_keys: [],
        preRun: [(function() {
            function charIn(c) {
                 vim_charIn(c);
            }
            Module.charIn = charIn;
            var _t = document.querySelector("#terminal-container").term;
            _t.on('key',(key,event)=>{
                console.log("XTERM input", key, event);
                event && event.preventDefault && event.preventDefault();
                __IO_KEYS.push({
                    "k" : key || event.key,
                    "c" : event.charCode,
                    "kc" : event.keyCode,
                });
                console.log("BUFFER", __IO_KEYS.length, __IO_KEYS);
            });
            FS.init(function() {
                console.log("NON-xvi stdin ?!?");
                return null;
            },charIn,function(c) {
                console.log("NON-xvi stdout/stderr", c);
            })
        })],
        postRun: [(function(){
            function timed_main_loop() {
                Module._jsvim_main_loop();
                setTimeout(timed_main_loop, 100);
            }
            console.log("START main loop");   
            timed_main_loop();
        })],
        print: (function(s) {console.log(s);}),
        printErr: (function(s) {console.log(s);}),
        canvas: (function() {}),
        setStatus: function(text) {},
        totalDependencies: 0,
        monitorRunDependencies: function(left) {},
    };
</script>
  </head>
            <body>

    <div id="terminal-container"></div> 

    <script type="text/javascript">
    (function() {
        var memoryInitializer = '../src/xvi.html.mem';
        if (typeof Module['locateFile'] === 'function') {
            memoryInitializer = Module['locateFile'](memoryInitializer);
        } else if (Module['memoryInitializerPrefixURL']) {
            memoryInitializer = Module['memoryInitializerPrefixURL'] + memoryInitializer;
        }
        var xhr = Module['memoryInitializerRequest'] = new XMLHttpRequest();
        xhr.open('GET', memoryInitializer, true);
        xhr.responseType = 'arraybuffer';
        xhr.send(null);
    })();

    jsvimOnLoad();

    var script = document.createElement('script');
    script.src = "../src/xvi.js";
    document.body.appendChild(script);
    </script>
  </body>
</html>
<!-- vim: set ts=2 sw=2 sts=2 expandtab foldmethod=marker : --> 


