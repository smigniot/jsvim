<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width" />
<link rel="stylesheet" type="text/css" href="zion.css"></link>
<script type="text/javascript" src="CustomElements.min.js">
</script>
<script type="text/javascript" src="terminal.js">
</script>
<script type="text/javascript" src="jsvim_term.js">
</script>
<script type='text/javascript'>

var ansiescape = [];
function vim_charIn(c) {
    try {
        unsafe_vim_charIn(c);
    } catch(err) {
        console.log("CHARINERR", c, err);
    }
}
function unsafe_vim_charIn(c) {
    //console.log("vimcharin", c, String.fromCharCode(c));
    var term = document.querySelector("zion-terminal"),
        caret = term.safeCaret()
        ;
    if(c == 27) {
        ansiescape = [27];
    } else if(ansiescape.length) {
        ansiescape.push(c);
        var sequence = ansiescape.map(function(e){
            return String.fromCharCode(e)}).join("");
        var handled = true, m;
        if(sequence == "\033[2J") {
            caret.before.deleteData(0, caret.before.length);
            caret.after.deleteData(0, caret.after.length);
        } else if(m = sequence.match(/^\033\[<(\d+)>;<(\d+)>f$/)) {
            var row = +(m[1]),
                col = +(m[2]);
            term.moveTo(row,col);
            //console.log("MOVE", row, col);
        } else if(sequence == "\033[1B") {
            term.caretDown();
            console.log("DOWN");
        } else {
            handled = false;
            console.log("PENDING", sequence);
        }
        if(handled) {
            ansiescape = [];
        }
    } else {
        console.log("INSERT", String.fromCharCode(c));
        caret.before.appendData(String.fromCharCode(c));
    }
    //console.log("vimcharin 2", c, String.fromCharCode(c));
    /*
    var text = document.createTextNode(str);
    if(caret)  { term.insertBefore(text, caret);  }
    else       { term.appendChild(text);          }
    console.log("STDOUT", c, String.fromCharCode(c));
    */
}
var Module = {
    charIn: vim_charIn,
    preRun: [(function(){
        // init: function(input, output, error)
        FS.init(function() {
            //throw new Error("Input asked");
            return null;
        }, vim_charIn, function(c) {
            console.log("STDERR", c, String.fromCharCode(c));
        });
    })],
    postRun: [(function(){
        var debug = document.querySelector("debug");
        function mainloop() {
            Module.ccall("jsvim_main_loop");
            if(debug) { debug.textContent = new Date(); }
            setTimeout(mainloop, 50);
        }
        mainloop();
    })],
    print: (function(text) {
        console.log("STDOUT", text);
        if (arguments.length > 1)
            text = Array.prototype.slice.call(arguments).join(' ');
    }),
    printErr: (function(text) {
        console.log("STDERR", text);
        if (arguments.length > 1)
            text = Array.prototype.slice.call(arguments).join(' ');
    }),
    canvas: (function() {}),
    setStatus: function(text) {},
    totalDependencies: 0,
    monitorRunDependencies: function(left) {},
}
</script>
<script type="text/javascript" src="xvi.js">
</script>
<style type="text/css">
html,body { width:100%; height:100%; margin:0; padding:0; }
body { background: linear-gradient(#80acaf, #dbe6e8); }
</style>
</head>
<body>

<zion-terminal id="jsvim" tabindex="0"><zion-caret id="caret" style="position:absolute;"></zion-caret></zion-terminal>
<footer id="debug" style="position:fixed;bottom:0;right:0;"></footer>

</body>
</html>
